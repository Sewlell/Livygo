<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livygo - Main Browser</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            display: flex;
            height: 100vh;
        }

        .left-section, .center-section, .right-section {
            padding: 20px;
            border: 1px solid #ccc;
        }

        .left-section {
            width: 20%;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .center-section {
            width: 60%;
            height: 100vh;
            overflow-y: auto;
            background-color: #e4e4e4;
            padding-top: 0;
        }

        .right-section {
            width: 20%;
            background-color: #f4f4f4;
            position: relative;
        }

        .pathway-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #e4e4e4;
            padding: 20px 0;
            margin-bottom: 0;
        }

        #pathway-circle {
            padding: 20px;
        }

        .section-container {
            margin-bottom: 40px;
        }

        .section-header {
            background-color: #8B0000;
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .circle-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 15px;
            padding: 10px;
        }

        .lesson {
            width: 50px;
            height: 50px;
            background-color: #ccc;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
        }

        .lesson:hover {
            transform: scale(1.1);
        }

        .global-dropdown-container {
            position: fixed;
            z-index: 1000;
            pointer-events: none;
        }


        .circle-dropdown {
            position: absolute;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 200px;
            pointer-events: auto;
            transition: opacity 0.2s, transform 0.2s;
        }

        .circle-dropdown {
            position: absolute;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 200px;
            pointer-events: auto;
            transition: opacity 0.2s, transform 0.2s;
        }

        .dropdown-visible {
            opacity: 1;
            transform: translateY(0);
        }

        .dropdown-hidden {
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }

        .lesson:hover {
            z-index: 100;
        }

        .progress-container {
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin: 0.5rem 0;
        }

        .progress-bar {
            height: 100%;
            background: #8B0000;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .course-selector {
            position: relative;
            cursor: pointer;
        }

        .current-course {
            padding: 8px 12px;
            border-radius: 8px;
            background-color: #fff;
            transition: background-color 0.2s;
        }

        .current-course:hover {
            background-color: #f0f0f0;
        }

        .courses-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-width: 180px;
            z-index: 100;
            display: none;
        }

        .courses-dropdown div {
            padding: 12px;
            transition: background-color 0.2s;
        }

        .courses-dropdown div:hover {
            background-color: #f8f8f8;
        }

        .add-course {
            color: #666;
            font-style: italic;
        }

        .guidebook-container {
            position: fixed;
            top: 0;
            left: 20%;
            width: 60%;
            height: 100vh;
            background: white;
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transform: translateX(140%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .guidebook-container.active {
            transform: translateX(0);
            opacity: 1;
            pointer-events: auto;
        }

        .guidebook-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .guidebook-container.slide-out {
            transform: translateX(-140%);
        }

        .chapter-header {
            padding: 15px;
            background: #f8f8f8;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
            padding: 12px;
            border-radius: 8px;
        }

        .guidebook-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
        }

        .back-btn {
            padding: 10px 15px;
            background: #8B0000;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .flag-button {
            padding: 10px 15px;
            border-radius: 8px;
            background-color: #fff;
            border: 1px solid #ddd;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Active state (matches course selector) */
        .active-flag {
            background-color: #8B0000;
            color: white;
            border-color: #8B0000;
        }

        /* Sub-options styling */
        .flag-option {
            padding: 8px 12px;
            border-radius: 6px;
            background-color: #f8f8f8;
            border: 1px solid #eee;
        }

        .sub-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 0;
        }

        .error {
            color: #721c24;
            padding: 1rem;
            background: #f8d7da;
            border-radius: 8px;
            margin: 1rem;
        }

        /* Hover effects */
        .flag-button:hover:not(.active-flag) {
            background-color: #f0f0f0;
        }

        .flag-option:hover {
            background-color: #e0e0e0;
        }

        .lesson-count {
            margin-bottom: 1rem;
            display: block;
        }

        .chapter-list {
            padding: 20px;
            display: grid;
            gap: 15px;
        }

        .chapter-item {
            padding: 1.2rem;
            background: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid rgba(139,0,0,0.1);
        }

        .chapter-item:hover {
            transform: translateY(-2px);
            background: #f8f8f8;
        }

        /* Chapter Page Header */
        .guidebook-header h3 {
            color: #8B0000;
            border-bottom: 2px solid #8B0000;
            padding-bottom: 0.5rem;
        }

        .guidebook-content {
            transition: opacity 0.3s ease;
            padding: 1.5rem;
            margin: 0 auto;
            max-width: 800px;
        }

        .error-content {
            text-align: center;
            padding: 2rem;
            color: #721c24;
            background-color: #f8d7da;
            border-radius: 8px;
            margin: 2rem;
        }

        .guide-media {
            margin: 1.5rem 0;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .text-section {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .text-section h1, .text-section h2, .text-section h3 {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .text-section p {
            margin-bottom: 1rem;
        }

        /* Add styling for checklist items */
        .task-item {
        list-style: none;
        margin: 0.5rem 0;
        }

        .task-item input[type="checkbox"] {
        margin-right: 0.8rem;
        }

        .text-section code {
            background: #f3f3f3;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-family: monospace;
        }

        .text-section pre {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            margin: 1rem 0;
            border: 1px solid #ddd;
        }

        .text-section pre code {
            background: none;
            padding: 0;
            font-size: 0.9em;
        }

        .text-section blockquote {
            border-left: 4px solid #8B0000;
            margin: 1rem 0;
            padding: 1rem;
            color: #666;
            background: #f8f8f8;
            display: flex;
            align-items: center;
            min-height: 60px;
        }

        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 2rem;
            gap: 15px;
        }

        .profile-title {
            margin: 0;
            color: #8B0000;
        }

        .profile-container {
            position: fixed;
            top: 0;
            left: 20%;
            width: 60%;
            height: 100vh;
            background: white;
            z-index: 2001;
            padding: 2rem;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            transform: translateX(175%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            bottom: -40px;
            left: 30px;
            pointer-events: none;
        }

        .profile-container.active {
            transform: translateX(30%);
            pointer-events: auto;
        }

        .profile-banner {
        position: relative;
        height: 200px;
        background: #f0f0f0;
        border-radius: 12px;
        overflow: visible;
        }

        #profileBanner {
        width: 100%;
        height: 100%;
        object-fit: cover;
        }

        .avatar-container {
        position: absolute;
        bottom: -40px;
        left: 20px;
        width: 110px;
        height: 110px;
        border-radius: 50%;
        border: 3px solid white;
        overflow: hidden;
        background: #fff;
        z-index: 3;
        }

        #profileAvatar {
        width: 100%;
        height: 100%;
        object-fit: cover;
        }

        .edit-profile-btn {
            position: absolute;
            right: 20px;
            background: #8B0000;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
        }

        .username {
            margin-top: 50px;
            margin-bottom: 1rem;
        }

        /* Stats Section */
        .stats-section {
            display: flex;
            gap: 2rem;
            margin: 2rem 0;
            padding: 1.5rem;
            background: #f8f8f8;
            border-radius: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #8B0000;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        /* Achievements Section */
        .achievements-section {
            margin-top: 2rem;
        }

        .achievements-section h3 {
            color: #8B0000;
            margin-bottom: 1.5rem;
        }

        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 1.5rem;
        }

        .achievement-item {
            text-align: center;
            padding: 1rem;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="left-section">
        <button class="flag-button">🏪 Shop</button>
        <button class="flag-button" onclick="showProfile()">👤 Profile</button>
        <button id="pathway-btn" class="flag-button active-flag">
            📚 Pathway
        </button>
        <div class="sub-options" id="pathway-options"></div>
        <button id="practice-btn">Practice</button>
        <div class="sub-options" id="practice-options">
            <button>General</button>
            <button>Vocabulary</button>
            <button>Grammar</button>
        </div>
        <div class="dev-mode">
            <button id="debug-test">Debug Test (Reset Progress)</button>
        </div>
    </div>

    <div class="center-section">
        <div class="pathway-header">
            <h2>Pathway</h2>
            <div class="course-selector">
                <div class="current-course" id="currentCourse">Spanish</div>
                <div class="courses-dropdown" id="coursesDropdown">
                    <div data-lang="ES-en">🇪🇸 Spanish</div>
                    <div data-lang="JP-en">🇯🇵 Japanese</div>
                    <div class="add-course" onclick="window.location.href='add_course.html'" style="cursor: pointer;">
                        + Add New Course
                    </div>
                </div>
            </div>
        </div>
        <div id="pathway-circle"></div>
    </div>

    <div class="right-section">
        <div class="mascot"></div>
        <div class="daily-quests">
            <div class="daily-quest">Daily Quest 1</div>
            <div class="daily-quest">Daily Quest 2</div>
            <div class="daily-quest">Daily Quest 3</div>
        </div>
    </div>

    <div id="global-dropdown-container" class="global-dropdown-container"></div>

    <div class="profile-container">
        <div class="profile-header">
          <button class="back-btn" onclick="hideProfile()">← Back</button>
          <h2 class="profile-title">Profile</h2>
          <button class="edit-profile-btn">✎ Edit</button>
        </div>
        <div class="profile-content">
          <div class="profile-banner">
            <img src="" alt="Profile banner" id="profileBanner">
            <div class="avatar-container">
              <img src="" alt="Avatar" id="profileAvatar">
            </div>
          </div>
          <div class="profile-info">
            <h1 id="profileUsername" class="username"></h1>
            <p id="profileBio" class="bio"></p>
            
            <!-- Stats Section -->
            <div class="stats-section">
              <div class="stat-item">
                <div class="stat-value" id="streakCount">0</div>
                <div class="stat-label">Day Streak</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="xpCount">0</div>
                <div class="stat-label">Total XP</div>
              </div>
              <div class="stat-item">
                <div class="stat-value" id="coursesCount">0</div>
                <div class="stat-label">Courses</div>
              </div>
            </div>
      
            <!-- Achievements Section -->
            <div class="achievements-section">
              <h3>Achievements</h3>
              <div id="achievementsList" class="achievements-grid"></div>
            </div>
          </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        function getBasePath() {
            const hostname = window.location.hostname;
            if (hostname.includes('github.io') || hostname.includes('vercel.app')) {
                const pathname = window.location.pathname;
                const repoName = pathname.split('/')[1];
                return `/${repoName}/`;
            } else {
                return '/';
            }
        }
        const LIVYGO_BASE_PATH = getBasePath();
        
        let currentLang = localStorage.getItem('selectedLang') || 'ES-en';
        let currentDropdown = null;
        let hoverTimeout = null;
        let currentSubCourse = localStorage.getItem('selectedSubCourse') || 'General';
        let navigationStack = [];
        let currentGuidebookContainer = null;
        let guidebookContainer = null;
        let isAnimating = false;
        let guidebookHistory = [];
        let activeGuidebook = null;
        let previousGuidebooks = [];


        

        // Initialize with both parameters
        function init() {
            loadSubCourses(currentLang);
            updatePathway();
        }
        init();
    
        // Course selector functionality
        document.getElementById('currentCourse').addEventListener('click', function(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('coursesDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
    
        document.querySelectorAll('#coursesDropdown div').forEach(item => {
            item.addEventListener('click', async function() {
                if (this.classList.contains('add-course')) return;
                
                currentLang = this.dataset.lang;
                const langName = this.textContent.split(' ').slice(1).join(' ');
                document.getElementById('currentCourse').textContent = langName;
                document.getElementById('coursesDropdown').style.display = 'none';
                
                // Load new subcourses and validate selection
                await loadSubCourses(currentLang);
                const validSubCourse = document.querySelector(`#pathway-options [data-subcourse="${currentSubCourse}"]`);
                if (!validSubCourse) {
                    currentSubCourse = document.querySelector('#pathway-options button')?.dataset.subcourse || '';
                }
                
                localStorage.setItem('selectedLang', currentLang);
                localStorage.setItem('selectedSubCourse', currentSubCourse);
                updatePathway();
            });
        });

        // Generating a lesson URL
        function getLessonUrl(code) {
            const [circleCode, lessonNumber] = code.split('-');
            return `lesson.html?section=${circleCode.slice(0,3)}&circle=${circleCode.slice(3,6)}&lesson=${lessonNumber}`;
        }
    
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.course-selector')) {
                document.getElementById('coursesDropdown').style.display = 'none';
            }
        });
    
        async function updatePathway() {
            try {
                // Fetch pathway structure (Corrected Path)
                const pathwayStructure = await fetch(`${LIVYGO_BASE_PATH}courses/${currentLang}/${currentSubCourse}/pathway_structure.json`)
                    .then(r => r.json());

                const pathwayCircle = document.getElementById('pathway-circle');
                pathwayCircle.innerHTML = ''; // Clear previous content

                pathwayStructure.forEach(section => {
                    const sectionContainer = document.createElement('div');
                    sectionContainer.className = 'section-container';

                    const header = document.createElement('div');
                    header.className = 'section-header';
                    header.innerHTML = `
                        <div>${section.title}</div>
                        <small>Circles ${section.addressMap[0].rangeStart} - ${section.addressMap.slice(-1)[0].rangeEnd}</small>
                    `;

                    const grid = document.createElement('div');
                    grid.className = 'circle-grid';

                    section.addressMap.forEach(range => {
                        const start = parseInt(range.rangeStart);
                        const end = parseInt(range.rangeEnd);

                        for (let codeNum = start; codeNum <= end; codeNum++) {
                            const paddedCode = codeNum.toString().padStart(6, '0');
                            const sectionCode = paddedCode.substring(0, 3);
                            
                            const circle = document.createElement('div');
                            circle.className = 'lesson';
                            circle.textContent = paddedCode.slice(-2);
                            circle.dataset.code = paddedCode;
                            
                            // Build dynamic base path (Corrected Path)
                            const circleBasePath = `${LIVYGO_BASE_PATH}courses/${currentLang}/${currentSubCourse}/${sectionCode}/`;
                            circle.dataset.basePath = circleBasePath;

                            addCircleEventListeners(circle);

                            // Click handler with all parameters (Corrected Path)
                            circle.addEventListener('click', () => {
                                const questionUrl = `${LIVYGO_BASE_PATH}question.html?lang=${currentLang}&subcourse=${currentSubCourse}&code=${paddedCode}`;
                                window.location.href = questionUrl;
                            });

                            grid.appendChild(circle);
                        }
                    });

                    sectionContainer.appendChild(header);
                    sectionContainer.appendChild(grid);
                    pathwayCircle.appendChild(sectionContainer);
                });

            } catch (error) {
                console.error('Failed to load pathway:', error);
                document.getElementById('pathway-circle').innerHTML = 
                    '<div class="error">Failed to load pathway data</div>';
            }
        }

        function addCircleEventListeners(circle) {
            let hoverTimer;

            circle.addEventListener('mouseenter', () => {
                hoverTimer = setTimeout(() => handleCircleHover(circle), 300);
            });

            circle.addEventListener('mouseleave', () => {
                clearTimeout(hoverTimer);
                hideDropdown();
            });

            circle.addEventListener('click', (e) => {
                clearTimeout(hoverTimer);
                if (currentDropdown) {
                    currentDropdown.remove();
                    currentDropdown = null;
                }
            });
        }
    
        async function handleCircleHover(circleElement) {
            const storedProgress = JSON.parse(localStorage.getItem(`lessonProgress_${currentLang}`)) || [];
            
            if (currentDropdown) {
                currentDropdown.classList.remove('dropdown-visible');
                currentDropdown.classList.add('dropdown-hidden');
            }

            const dropdown = document.createElement('div');
            dropdown.className = 'circle-dropdown dropdown-hidden';
            const rect = circleElement.getBoundingClientRect();
            dropdown.style.left = `${rect.left + rect.width / 2}px`;
            dropdown.style.top = `${rect.bottom + 10}px`;
            dropdown.style.transform = `translateX(-50%)`;

            const container = document.getElementById('global-dropdown-container');
            container.appendChild(dropdown);

            try {
                const basePath = circleElement.dataset.basePath;
                // The fetch for lesson_progress.json uses basePath, which is already corrected.
                const progressData = await fetch(`${basePath}lesson_progress.json`).then(r => r.json());
                // The fetch for guide_structure.json needs to be corrected.
                const guideStructure = await fetch(`${LIVYGO_BASE_PATH}courses/${currentLang}/${currentSubCourse}/guidebook/guide_structure.json`)
                    .then(r => r.json())
                    .catch(() => ({ categories: [], guidebooks: [] }));

                const circleCode = circleElement.dataset.code;
                
                const relatedCategories = (guideStructure.categories || []).filter(c => {
                    if (!c.relatedCircles || c.relatedCircles.length === 0) return true;
                    return c.relatedCircles.includes(circleCode);
                });
                
                const validCategories = relatedCategories.filter(c => 
                    c?.guidcode && c?.title && c?.chapters?.length > 0
                );

                const lessonData = storedProgress.find(p => p.code === circleElement.dataset.code) || 
                                progressData.find(p => p.code === circleElement.dataset.code) || 
                                { current: 1, total: 5, title: "Default Title" };

                dropdown.innerHTML = `
                    <div class="dropdown-header">${lessonData.title}</div>
                    <div class="progress-container">
                        <div class="progress-bar" style="width: ${(lessonData.current / lessonData.total) * 100}%"></div>
                    </div>
                    <div class="lesson-count">Lesson ${lessonData.current}/${lessonData.total}</div>
                    ${validCategories.map(category => `
                        <button class="flag-option" 
                            onclick="showGuidebook('${category.guidcode}')"
                            data-guidcode="${category.guidcode}">
                            📖 ${category.title}
                        </button>
                    `).join('')}
                `;

                dropdown.classList.remove('dropdown-hidden');
                dropdown.classList.add('dropdown-visible');
                currentDropdown = dropdown;

                dropdown.addEventListener('mouseenter', () => clearTimeout(hoverTimeout));
                dropdown.addEventListener('mouseleave', () => hideDropdown());
            } catch (error) {
                console.error('Dropdown error:', error);
                dropdown.innerHTML = `<div class="error">Error loading guides</div>`;
            }
        }
    
        function hideDropdown() {
            hoverTimeout = setTimeout(() => {
                if (currentDropdown) {
                    currentDropdown.classList.remove('dropdown-visible');
                    currentDropdown.classList.add('dropdown-hidden');
                    currentDropdown = null;
                }
            }, 200);
        }

        async function loadSubCourses(lang) {
            const pathwayOptions = document.getElementById('pathway-options');
            pathwayOptions.innerHTML = ''; // Clear existing buttons

            try {
                const response = await fetch(`${LIVYGO_BASE_PATH}courses/${lang}/sub_courses.json`);
                const { sub_courses } = await response.json();

                sub_courses.forEach(sc => {
                    const button = document.createElement('button');
                    button.className = 'flag-option';
                    button.dataset.subcourse = sc.id.toLowerCase(); 
                    button.innerHTML = `${sc.icon} ${sc.title}`;
                    button.addEventListener('click', () => selectSubCourse(sc.id));
                    pathwayOptions.appendChild(button);
                });

                if (sub_courses.length > 0) {
                        const isValid = sub_courses.some(sc => sc.id === currentSubCourse);
                        if (!isValid) currentSubCourse = sub_courses[0].id;
                        localStorage.setItem('selectedSubCourse', currentSubCourse);
                    }
            } catch (error) {
                console.error('Failed to load subcourses:', error);
                pathwayOptions.innerHTML = '<div class="error">No subcourses available</div>';
            }
        }

        function selectSubCourse(subCourseId) {
            currentSubCourse = subCourseId;
            localStorage.setItem('selectedSubCourse', currentSubCourse);
            updatePathway();
        }

        function createGuidebookContainer() {
            if (!guidebookContainer) {
                guidebookContainer = document.createElement('div');
                guidebookContainer.className = 'guidebook-container';
                document.body.appendChild(guidebookContainer);
            }
            return guidebookContainer;
        }

        // Modify the checklist rendering in your Markdown parser configuration
        marked.use({
        renderer: {
            listitem(text, task, checked) {
            if (task) {
                return `<li class="task-item">
                <label>
                    <input type="checkbox" name="guidebook-task" ${checked ? 'checked' : ''}>
                    ${text.replace(/^\s*\[[x\s]\]\s*/, '')}
                </label>
                </li>`;
            }
            return `<li>${text}</li>`;
            }
        }
        });

        async function fetchGuidebookContent(guidcode) {
            try {
                const isCategory = guidcode.startsWith('CAT-');
                const guideStructure = await fetch(`${LIVYGO_BASE_PATH}courses/${currentLang}/${currentSubCourse}/guidebook/guide_structure.json`)
                    .then(res => res.json());
                if (isCategory) {
                    const category = guideStructure.categories.find(c => c.guidcode === guidcode);
                    if (!category) throw new Error('Category not found');
                    return `
                        <div class="guidebook-header">
                            <button class="back-btn" onclick="handleBackNavigation()">← Back to Pathway</button>
                            <h2>${category.title}</h2>
                            <button class="guidebook-close" onclick="hideGuidebook()">×</button>
                        </div>
                        <div class="chapter-list">
                            ${category.chapters.map(chapterId => {
                                const chapter = guideStructure.guidebooks.find(g => g.guidcode === chapterId);
                                return `<div class="chapter-item" onclick="showGuidebook('${chapterId}')">
                                    ${chapter ? chapter.title : 'Unknown Chapter'}
                                </div>`;
                            }).join('')}
                        </div>
                    `;
                } else {
                    const guideMeta = guideStructure.guidebooks.find(g => g.guidcode === guidcode);
                    if (!guideMeta) throw new Error('Guidebook chapter not found');
                    const metaResponse = await fetch(`${LIVYGO_BASE_PATH}courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/meta.json`);
                    if (!metaResponse.ok) throw new Error('Meta.json not found');
                    const meta = await metaResponse.json();
                    const sectionsHtml = await Promise.all(meta.sections.map(async section => {
                        if (section.type === 'text') {
                            const text = await fetch(`${LIVYGO_BASE_PATH}courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/${section.content}`)
                                .then(r => r.text());
                            return `<div class="text-section">${marked.parse(text)}</div>`;
                        }
                        if (section.type === 'media') {
                            const mediaPath = `${LIVYGO_BASE_PATH}courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/media/${section.content}`;
                            return `<img src="${mediaPath}" class="guide-media" alt="Learning visual">`;
                        }
                        return '';
                    }));
                    const parentCategory = guideStructure.categories.find(c => c.chapters.includes(guidcode));
                    return `
                        <div class="guidebook-header">
                            <button class="back-btn" onclick="handleBackNavigation()">← Back</button>
                            <h3>${guideMeta.title}</h3>
                            <button class="guidebook-close" onclick="hideGuidebook()">×</button>
                        </div>
                        <div class="guidebook-content">
                            ${sectionsHtml.join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading guidebook content:', error);
                return `
                    <div class="error-content">
                        <h4>Content Not Available</h4>
                        <p>The requested learning material could not be loaded.</p>
                        <button onclick="hideGuidebook()" class="back-btn">
                            ← Return to Main Page
                        </button>
                    </div>
                `;
            }
        }

        async function fetchCategory(categoryId) {
            const guideStructure = await fetch(`/courses/${currentLang}/${currentSubCourse}/guidebook/guide_structure.json`)
                .then(res => res.json());
            return guideStructure.categories.find(c => c.guidcode === categoryId);
        }

        async function fetchChapterContent(guidcode) {
            try {
                const guideStructure = await fetch(`/courses/${currentLang}/${currentSubCourse}/guidebook/guide_structure.json`).then(res => res.json());
                const guideMeta = guideStructure.guidebooks.find(g => g.guidcode === guidcode);
                
                // New: Validate meta.json exists
                const metaResponse = await fetch(`/courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/meta.json`);
                if (!metaResponse.ok) throw new Error('Meta.json not found');
                
                const meta = await metaResponse.json();
                
                // New: Process content files
                const processedSections = await Promise.all(meta.sections.map(async section => {
                    if (section.type === 'text') {
                        const content = await fetch(`/courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/${section.content}`).then(r => r.text());
                        return { ...section, content };
                    }
                    return section;
                }));

                return {
                    ...guideMeta,
                    sections: processedSections
                };
            } catch (error) {
                console.error('Failed to load chapter content:', error);
                return {
                    title: "Content Unavailable",
                    sections: [{
                        type: 'error',
                        content: `
                            <div class="error-content">
                                <h4>Guidebook Missing</h4>
                                <p>This learning resource is not available yet.</p>
                                <button onclick="hideGuidebook()" class="back-btn">
                                    ← Return to Main Page
                                </button>
                            </div>
                        `
                    }]
                };
            }
        }

        function renderContentSections(sections, guidcode) {
            return sections.map(section => {
                if (section.type === 'text') {
                    const processedContent = section.content
                        .replace(/- \[ \]/g, '- [ ]')
                        .replace(/- \[x\]/g, '- [x]');
                    return `<div class="text-section">${marked.parse(section.content)}</div>`;
                }
                if (section.type === 'media') {
                    const mediaPath = `/courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/media/${section.content}`;
                    return `<img src="${mediaPath}" class="guide-media" alt="Learning visual">`;
                }
                if (section.type === 'error') {
                    return section.content;
                }
                return '';
            }).join('');
        }

        async function showGuidebook(guidcode) {
            // If we're navigating forward and the guidcode is not already current, push it
            if (!navigationStack.length || navigationStack[navigationStack.length - 1] !== guidcode) {
                navigationStack.push(guidcode);
            }
            
            // Use (or create) a single global container for guidebook content
            const container = createGuidebookContainer();
            
            // Indicate that we are loading new content (disable further animations if needed)
            isAnimating = true;
            
            try {
                // Fetch the content based on the guidcode
                const content = await fetchGuidebookContent(guidcode);
                // Update the container's innerHTML with the new content
                container.innerHTML = content;
                // Trigger slide-in animation (assumes CSS transitions based on the 'active' class)
                // Remove any previous slide-out classes first
                container.classList.remove('slide-out');
                // Delay slightly to ensure DOM update before animation class is added
                setTimeout(() => {
                    container.classList.add('active');
                }, 10);
                } catch (error) {
                console.error('Error loading guidebook content:', error);
            }
            
            isAnimating = false;
        

            function createNewContainer() {
                fetch(`/courses/${currentLang}/${currentSubCourse}/guidebook/guide_structure.json`)
                .then(res => res.json())
                .then(guideStructure => {
                    // Check if it's a category first
                    const category = guideStructure.categories.find(c => c.guidcode === guidcode);
                    if (category) {
                        renderCategoryPage(category, guideStructure);
                        return;
                    }
                    // Otherwise, assume it's a chapter
                    const guideMeta = guideStructure.guidebooks.find(g => g.guidcode === guidcode);
                    if (guideMeta) {
                        const parentCategory = guideStructure.categories.find(c =>
                            c.chapters.includes(guidcode)
                        );
                        renderChapterPage(guideMeta, parentCategory, guideStructure);
                    }
                    })
                    .catch(error => {
                    console.error('Failed to load guide structure:', error);
                    });
            }
        }

        function hideGuidebook() {
            if (!guidebookContainer || isAnimating) return;
            isAnimating = true;
            // Remove the 'active' class so the container slides out (per your CSS transform)
            guidebookContainer.classList.remove('active');
            // When the transition ends, clear the container and reset the navigation stack
            guidebookContainer.addEventListener('transitionend', () => {
                guidebookContainer.innerHTML = '';
                navigationStack = [];
                guidebookContainer.remove();
                guidebookContainer = null;
                isAnimating = false;
            }, { once: true });
        }

        function renderCategoryPage(category, guideStructure) {
            const container = document.createElement('div');
            container.className = 'guidebook-container';
            currentGuidebookContainer = container;

            // Removed inline transform styles
            container.innerHTML = `
                <div class="guidebook-header">
                    <button class="back-btn" onclick="handleBackNavigation()">
                        ← ${navigationStack.length > 1 ? 'Back' : 'Close'}
                    </button>
                    <h2>${category.title}</h2>
                    <button class="guidebook-close" onclick="hideGuidebook()">×</button>
                </div>
                <div class="chapter-list">
                    ${category.chapters.map(chapterId => {
                        const chapter = guideStructure.guidebooks.find(g => g.guidcode === chapterId);
                        return `<div class="chapter-item" onclick="showGuidebook('${chapterId}')">
                            ${chapter?.title || 'Unknown Chapter'}
                        </div>`;
                    }).join('')}
                </div>
            `;
            document.body.appendChild(container);
            // Trigger animation by adding the 'active' class
            setTimeout(() => {
                container.classList.add('active');
            }, 10);
        }

        function renderChapterPage(guideMeta, parentCategory, guideStructure) {
            const container = document.createElement('div');
            container.className = 'guidebook-container';
            currentGuidebookContainer = container;

            // Removed inline transform styles
            container.innerHTML = `
                <div class="guidebook-header">
                    <button class="back-btn" onclick="handleBackNavigation()">
                        ← Back
                    </button>
                    <h3>${guideMeta.title}</h3>
                    <button class="guidebook-close" onclick="hideGuidebook()">×</button>
                </div>
                <div class="guidebook-content"></div>
            `;
            
            fetch(`/courses/${currentLang}/${currentSubCourse}/guidebook/${guideMeta.guidcode}/meta.json`)
                .then(res => res.json())
                .then(contentMeta => {
                    renderGuideContent(container.querySelector('.guidebook-content'), 
                                    guideMeta.guidcode, contentMeta);
                });

            document.body.appendChild(container);
            // Trigger animation by adding the 'active' class
            setTimeout(() => {
                container.classList.add('active');
            }, 10);
        }

        function closeGuidebook() {
            navigationStack = [];
            if (!currentGuidebookContainer) return;
            
            currentGuidebookContainer.style.transform = 'translateX(100%)';
            
            currentGuidebookContainer.addEventListener('transitionend', () => {
                currentGuidebookContainer.remove();
                currentGuidebookContainer = null;
            }, { once: true });
        }

        function renderGuideContent(container, guidcode, contentMeta) {
            // Clear previous content
            container.innerHTML = '';

            // Load main content sections
            contentMeta.sections.forEach(section => {
                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'guide-section';
                
                switch(section.type) {
                    case 'text':
                        fetch(`/courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/${section.content}`)
                            .then(res => res.text())
                            .then(text => {
                                sectionDiv.innerHTML = marked.parse(text);
                            });
                        break;
                        
                    case 'media':
                        const img = document.createElement('img');
                        img.src = `/courses/${currentLang}/${currentSubCourse}/guidebook/${guidcode}/media/${section.content}`;
                        img.style.maxWidth = '100%';
                        sectionDiv.appendChild(img);
                        break;
                }
                
                container.appendChild(sectionDiv);
            });
        }

        function handleBackNavigation() {
            if (navigationStack.length > 1) {

                // Pop the current page and show the previous one
                navigationStack.pop();
                const previousGuid = navigationStack[navigationStack.length - 1];
                showGuidebook(previousGuid);

                // Only proceed if we have an active guidebook
                if (activeGuidebook) {
                    // Animate current guidebook out
                    activeGuidebook.classList.remove('active');
                    activeGuidebook.classList.add('slide-out');
                    
                    // Remove after animation
                    activeGuidebook.addEventListener('transitionend', () => {
                        activeGuidebook.remove();
                    }, { once: true });

                    // Retrieve previous guidebook from history
                    const prevContainer = previousGuidebooks.pop();
                    if (prevContainer) {
                        // Activate previous guidebook
                        prevContainer.classList.add('active');
                        activeGuidebook = prevContainer;
                        document.body.appendChild(prevContainer);
                    }
                }
            } else {
                hideGuidebook();
            }
        }
    
        // Initialize pathway
        updatePathway(currentLang);










        // Profile Stuff

        let profileData = null;

        async function loadProfile() {
        try {
            const response = await fetch(`${LIVYGO_BASE_PATH}profile.json`);
            profileData = await response.json();
            updateProfileDisplay();
        } catch (error) {
            console.error('Error loading profile:', error);
        }
        }

        function updateProfileDisplay() {
        document.getElementById('profileUsername').textContent = profileData.profile.username;
        document.getElementById('profileBio').textContent = profileData.profile.bio;
        document.getElementById('profileBanner').src = profileData.profile.banner;
        document.getElementById('profileAvatar').src = profileData.profile.avatar;
        }

        function showProfile() {
        const container = document.querySelector('.profile-container');
        container.classList.add('active');
        loadProfile();
        }

        function hideProfile() {
        document.querySelector('.profile-container').classList.remove('active');
        }

        // Add event listener to profile button
        document.querySelector('.flag-button:nth-of-type(2)').addEventListener('click', showProfile);

        // Edit functionality
        document.querySelector('.edit-profile-btn').addEventListener('click', () => {
        // Implement edit modal
        const newBio = prompt('Enter new bio:', profileData.profile.bio);
        if(newBio) {
            profileData.profile.bio = newBio;
            updateProfileDisplay();
            // Here you would typically send to backend
        }
        });

        function updateProfileDisplay() {
        // Basic Info
        document.getElementById('profileUsername').textContent = profileData.profile.username;
        document.getElementById('profileBio').textContent = profileData.profile.bio;
        document.getElementById('profileBanner').src = profileData.profile.banner;
        document.getElementById('profileAvatar').src = profileData.profile.avatar;

        // Stats
        document.getElementById('streakCount').textContent = profileData.profile.stats.streak;
        document.getElementById('xpCount').textContent = profileData.profile.stats.xp;
        document.getElementById('coursesCount').textContent = profileData.profile.stats.courses_completed;

        // Achievements
        const achievementsList = document.getElementById('achievementsList');
        achievementsList.innerHTML = profileData.profile.achievements
            .map(achievement => `
            <div class="achievement-item">
                <div class="achievement-icon">${achievement.icon}</div>
                <div class="achievement-title">${achievement.title}</div>
                <small class="achievement-date">${achievement.date}</small>
            </div>
            `).join('');
        }
    </script>
</body>
</html>
